# Sushy-Tools Redfish Emulator Setup

Sushy-tools is now running as a containerized service providing Redfish API endpoints for your libvirt VMs.

## Service Information

- **Status**: Running (systemd container)
- **Port**: 8000
- **Host IP**: 192.168.1.51
- **Redfish API**: http://192.168.1.51:8000/redfish/v1/
- **Container Image**: quay.io/metal3-io/sushy-tools:latest

## VM to Redfish Mapping

| VM Name | UUID | Redfish Endpoint |
|---------|------|------------------|
| bcm-11 | 2a637948-4f17-4075-9446-468af7360697 | http://192.168.1.51:8000/redfish/v1/Systems/2a637948-4f17-4075-9446-468af7360697 |
| iec61850-publisher | f10692c1-f9d7-44ba-ab0f-8e5570cafc10 | http://192.168.1.51:8000/redfish/v1/Systems/f10692c1-f9d7-44ba-ab0f-8e5570cafc10 |
| iec61850-subscriber | f24f03ed-ca89-4331-9c9e-5bbef67da3d8 | http://192.168.1.51:8000/redfish/v1/Systems/f24f03ed-ca89-4331-9c9e-5bbef67da3d8 |
| win11 | 26d68a74-6d9a-4a84-abe9-1e17cbd28b22 | http://192.168.1.51:8000/redfish/v1/Systems/26d68a74-6d9a-4a84-abe9-1e17cbd28b22 |
| wks-fedora | 2e3d6960-50b0-4a89-8c0e-01caf739961d | http://192.168.1.51:8000/redfish/v1/Systems/2e3d6960-50b0-4a89-8c0e-01caf739961d |

## Service Management

### Check service status
```bash
sudo systemctl status sushy-emulator
```

### View logs
```bash
sudo journalctl -u sushy-emulator -f
```

### Restart service
```bash
sudo systemctl restart sushy-emulator
```

### Stop service
```bash
sudo systemctl stop sushy-emulator
```

## Testing Redfish API

### List all systems (VMs)
```bash
curl http://localhost:8000/redfish/v1/Systems | python3 -m json.tool
```

### Get VM details (example: bcm-11)
```bash
curl http://localhost:8000/redfish/v1/Systems/2a637948-4f17-4075-9446-468af7360697 | python3 -m json.tool
```

### Power operations via Redfish

#### Power on VM
```bash
curl -X POST http://localhost:8000/redfish/v1/Systems/2a637948-4f17-4075-9446-468af7360697/Actions/ComputerSystem.Reset \
  -H "Content-Type: application/json" \
  -d '{"ResetType": "On"}'
```

#### Graceful shutdown
```bash
curl -X POST http://localhost:8000/redfish/v1/Systems/2a637948-4f17-4075-9446-468af7360697/Actions/ComputerSystem.Reset \
  -H "Content-Type: application/json" \
  -d '{"ResetType": "GracefulShutdown"}'
```

#### Force off
```bash
curl -X POST http://localhost:8000/redfish/v1/Systems/2a637948-4f17-4075-9446-468af7360697/Actions/ComputerSystem.Reset \
  -H "Content-Type: application/json" \
  -d '{"ResetType": "ForceOff"}'
```

#### Set boot device to PXE
```bash
curl -X PATCH http://localhost:8000/redfish/v1/Systems/2a637948-4f17-4075-9446-468af7360697 \
  -H "Content-Type: application/json" \
  -d '{
    "Boot": {
      "BootSourceOverrideEnabled": "Once",
      "BootSourceOverrideTarget": "Pxe"
    }
  }'
```

## BCM Integration

### Configure BCM to use Redfish for out-of-band management

For each VM you want BCM to manage via Redfish:

```bash
# Example for bcm-11 VM
VM_NAME="bcm-11"
VM_UUID="2a637948-4f17-4075-9446-468af7360697"

# Configure Redfish BMC in BCM (from BCM head node)
cmsh -c "device use $VM_NAME; set bmc http://192.168.1.51:8000/redfish/v1/Systems/$VM_UUID"
```

### Using bcm_power Ansible module

Once configured in BCM, you can use the `bcm_power` module:

```yaml
- name: Power on VM via BCM Redfish
  nvidia.bcm.bcm_power:
    name: bcm-11
    state: on

- name: Check power status
  nvidia.bcm.bcm_power:
    name: bcm-11
    state: status
  register: power_status

- name: Power off VM
  nvidia.bcm.bcm_power:
    name: bcm-11
    state: off
```

## Configuration Files

### Container definition
```
/etc/containers/systemd/sushy-emulator.container
```

### Service configuration
```
Generated by systemd from .container file
```

## Troubleshooting

### VMs not showing in Redfish API

Check libvirt connection:
```bash
sudo virsh list --all
```

Check container logs:
```bash
sudo journalctl -u sushy-emulator -n 50
```

### Permission denied errors

Check SELinux policy (already fixed):
```bash
sudo ausearch -m avc -ts recent | audit2allow
```

### Container won't start

Check container status:
```bash
sudo podman ps -a | grep sushy
```

Restart the service:
```bash
sudo systemctl restart sushy-emulator
```

## Notes

- The Redfish emulator runs in debug mode for testing
- No authentication is currently configured
- For production use, consider:
  - Adding authentication via `SUSHY_EMULATOR_AUTH_FILE`
  - Using SSL/TLS certificates
  - Running behind a reverse proxy
  - Disabling debug mode

## Adding New VMs

When you create new VMs, they will automatically appear in the Redfish API:

1. Create the VM in libvirt:
   ```bash
   sudo virsh define vm.xml
   ```

2. Get the VM UUID:
   ```bash
   sudo virsh domuuid <vm-name>
   ```

3. The Redfish endpoint will be:
   ```
   http://192.168.1.51:8000/redfish/v1/Systems/<vm-uuid>
   ```

4. Configure in BCM:
   ```bash
   cmsh -c "device use <vm-name>; set bmc http://192.168.1.51:8000/redfish/v1/Systems/<vm-uuid>"
   ```
