---
# Prepare BCM Lite Daemon files for HTTP download during kickstart
# This makes the quadlet and per-node certificates available for nodes to download
#
# IMPORTANT: Bootstrap certificates do NOT work for LiteNode authentication.
# Each LiteNode needs its own certificate with profile=litenode issued by BCM.
# We generate these per-node certificates here and organize by MAC address
# so the kickstart can download the correct certificate for each node.

# Build BCM agent image and push to local registry
- name: Build and push BCM agent image
  ansible.builtin.include_role:
    name: bcm_agent_image
  vars:
    bcm_agent_push_to_registry: true
    bcm_agent_registry_host: "{{ ansible_fqdn }}:5000"
    bcm_agent_registry_image: "bcm-agent"
    bcm_agent_registry_tag: "{{ bcm_agent_tag }}"
  when: bcm_agent_build_image | bool

- name: Create BCM agent files directory in tftpboot
  ansible.builtin.file:
    path: "{{ tftpboot_path }}/bcm-agent"
    state: directory
    mode: '0755'

- name: Create BCM agent certs directory
  ansible.builtin.file:
    path: "{{ tftpboot_path }}/bcm-agent/certs"
    state: directory
    mode: '0755'

- name: Generate BCM agent quadlet configuration
  ansible.builtin.template:
    src: bcm-agent.container.j2
    dest: "{{ tftpboot_path }}/bcm-agent/bcm-agent.container"
    mode: '0644'

- name: Copy CA certificate to tftpboot
  ansible.builtin.copy:
    src: "/cm/local/apps/cmd/etc/cacert.pem"
    dest: "{{ tftpboot_path }}/bcm-agent/certs/cacert.pem"
    mode: '0644'
    remote_src: true

# Generate per-node litenode certificates using shared role
# MAC-based directory structure for kickstart downloads
- name: Generate litenode certificates for cluster nodes
  ansible.builtin.include_role:
    name: litenode_certificates
  vars:
    litenode_certs_dir: "{{ tftpboot_path }}/bcm-agent/certs"
    litenode_cert_dir_structure: "per_mac"

- name: Display BCM agent files location
  ansible.builtin.debug:
    msg:
      - "BCM agent files prepared for kickstart download:"
      - "  Quadlet: http://{{ bcm_internal_ip }}:{{ http_port }}{{ tftpboot_path }}/bcm-agent/bcm-agent.container"
      - "  Per-node certificates: http://{{ bcm_internal_ip }}:{{ http_port }}{{ tftpboot_path }}/bcm-agent/certs/<mac>/"
      - "  CA certificate: http://{{ bcm_internal_ip }}:{{ http_port }}{{ tftpboot_path }}/bcm-agent/certs/cacert.pem"
      - ""
      - "Nodes with certificates generated:"
      - "{% for node in cluster_nodes %}  - {{ node.name }}: {{ node.mac | lower }}\n{% endfor %}"
