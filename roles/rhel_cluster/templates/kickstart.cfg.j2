#version=RHEL{{ rhel_version.split('.')[0] }}
# Kickstart for {{ role.category }}
# Generated by Ansible nvidia.bcm.rhel_cluster role

# Installation source
url --url="http://{{ bcm_internal_ip }}:{{ http_port }}{{ tftpboot_path }}/repos/{{ rhel_repo_name }}"

# Additional repositories
repo --name="BaseOS" --install --baseurl=http://{{ bcm_internal_ip }}:{{ http_port }}{{ tftpboot_path }}/repos/{{ rhel_repo_name }}/BaseOS
repo --name="AppStream" --install --baseurl=http://{{ bcm_internal_ip }}:{{ http_port }}{{ tftpboot_path }}/repos/{{ rhel_repo_name }}/AppStream

# System authorization (authselect for RHEL 9+)
authselect select sssd --force

# Keyboard and language
keyboard --vckeymap={{ keyboard }}
lang {{ lang }}

# Network configuration
network --bootproto={{ network_bootproto }} --device={{ network_device }} --onboot={{ 'on' if network_onboot else 'off' }}

# Root password
rootpw --plaintext {{ root_password }}

# SSH keys for BCM head node management
{% for ssh_key in bcm_ssh_keys %}
sshkey --username=root "{{ ssh_key }}"
{% endfor %}

# Timezone
timezone {{ timezone }} --utc

# Disk configuration
ignoredisk --only-use={{ disk_device }}
{% if disk_clearpart %}
clearpart --all --initlabel
{% endif %}
autopart --type={{ disk_autopart_type }}

# Bootloader
bootloader --location=mbr

# SELinux
selinux --{{ selinux_mode }}

# Firewall
{% if firewall_enabled %}
firewall --enabled{% for service in firewall_services %} --service={{ service }}{% endfor %}

{% else %}
firewall --disabled
{% endif %}

# Skip X Window System
{% if kickstart_skipx %}
skipx
{% endif %}

# Reboot after installation
{% if kickstart_reboot %}
reboot
{% else %}
poweroff
{% endif %}

# Package selection
%packages
{% for package in role.packages | default([]) %}
{{ package }}
{% endfor %}
%end

# Post-installation script
%post --log=/root/ks-post.log

# Import Red Hat release GPG key
rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release

# Add EPEL repository which is needed for Slurm
dnf install -y https://dl.fedoraproject.org/pub/epel/epel-release-latest-9.noarch.rpm
rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-9

# Configure BCM repositories with credentials
curl -s -o /etc/yum.repos.d/cm.repo http://{{ bcm_internal_ip }}:{{ http_port }}{{ tftpboot_path }}/repos/{{ rhel_repo_name }}/repoconfig/cm.repo
curl -s -o /etc/yum.repos.d/cm-extra.repo http://{{ bcm_internal_ip }}:{{ http_port }}{{ tftpboot_path }}/repos/{{ rhel_repo_name }}/repoconfig/cm-extra.repo

# Import BCM GPG key
curl -s -o /etc/pki/rpm-gpg/RPM-GPG-KEY-cm http://{{ bcm_internal_ip }}:{{ http_port }}{{ tftpboot_path }}/repos/{{ rhel_repo_name }}/repoconfig/RPM-GPG-KEY-cm
rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-cm

# Install BCM compute node packages (static install, no boot-time sync)
# Core packages for inventory, monitoring/metrics, and Slurm management
dnf install -y \
  cm-slave \
  cmdaemon-remotecm \
  cmdaemon-pythoncm \
  cm-config-nfsclient \
  cm-config-ssh-slave \
  cm-config-syslog-slave \
  cm-config-xntp-slave \
  cm-config-dhclient \
  cm-config-dracut-slave \
  cm-config-rootfiles-slave \
  cm-config-systemd \
  cm-nvnodehealth \
  cm-prs \
  2>&1 | tee -a /root/bcm-install.log

# Install Slurm packages
dnf install -y slurm25.05-slurmd 2>&1 | tee -a /root/slurm-install.log

{% if role.post_script is defined %}
{{ role.post_script }}
{% endif %}

# Set hostname from DHCP or BCM
echo "Post-installation completed for {{ role.category }} at $(date)" >> /root/install-complete.txt
%end
