#version=RHEL{{ rhel_version.split('.')[0] }}
# Kickstart for {{ role.category }}
# Generated by Ansible nvidia.bcm.rhel_cluster role

# Installation source
url --url="http://{{ bcm_internal_ip }}:{{ http_port }}{{ tftpboot_path }}/repos/{{ rhel_repo_name }}"

# Additional repositories
repo --name="BaseOS" --install --baseurl=http://{{ bcm_internal_ip }}:{{ http_port }}{{ tftpboot_path }}/repos/{{ rhel_repo_name }}/BaseOS
repo --name="AppStream" --install --baseurl=http://{{ bcm_internal_ip }}:{{ http_port }}{{ tftpboot_path }}/repos/{{ rhel_repo_name }}/AppStream

# System authorization (authselect for RHEL 9+)
authselect select sssd --force

# Keyboard and language
keyboard --vckeymap={{ keyboard }}
lang {{ lang }}

# Network configuration
network --bootproto={{ network_bootproto }} --device={{ network_device }} --onboot={{ 'on' if network_onboot else 'off' }}

# Root password
rootpw --plaintext {{ root_password }}

# SSH keys for BCM head node management
{% for ssh_key in bcm_ssh_keys %}
sshkey --username=root "{{ ssh_key }}"
{% endfor %}

# Timezone
timezone {{ timezone }} --utc

# Disk configuration
ignoredisk --only-use={{ disk_device }}
{% if disk_clearpart %}
clearpart --all --initlabel
{% endif %}
autopart --type={{ disk_autopart_type }}

# Bootloader
bootloader --location=mbr

# SELinux
selinux --{{ selinux_mode }}

# Firewall
{% if firewall_enabled %}
firewall --enabled{% for service in firewall_services %} --service={{ service }}{% endfor %}

{% else %}
firewall --disabled
{% endif %}

# Skip X Window System
{% if kickstart_skipx %}
skipx
{% endif %}

# Reboot after installation
{% if kickstart_reboot %}
reboot
{% else %}
poweroff
{% endif %}

# Package selection
%packages
{% for package in role.packages | default([]) %}
{{ package }}
{% endfor %}
%end

# Post-installation script
%post --log=/root/ks-post.log

# Import Red Hat release GPG key
rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release

# Add EPEL repository which is needed for Slurm
dnf install -y https://dl.fedoraproject.org/pub/epel/epel-release-latest-9.noarch.rpm
rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-9

# Install podman for BCM Lite Daemon (if not already installed)
dnf install -y podman 2>&1 | tee -a /root/podman-install.log

# Create directories for BCM Lite Daemon
mkdir -p /etc/containers/systemd
mkdir -p /etc/bcm-agent/certs
mkdir -p /var/log/bcm-agent

# Download BCM Lite Daemon quadlet configuration
curl -s -o /etc/containers/systemd/bcm-agent.container \
  http://{{ bcm_internal_ip }}:{{ http_port }}{{ tftpboot_path }}/bcm-agent/bcm-agent.container

# Fix hostname in quadlet (systemd %H specifier doesn't work in Quadlet)
sed -i "s/%H/$(hostname)/g" /etc/containers/systemd/bcm-agent.container

# Get MAC address for this node to download the correct certificate
# The certificate is stored in a per-MAC directory on the BCM server
# Try BOOTIF from kernel cmdline first, then fall back to network interface
BOOTIF=$(cat /proc/cmdline | grep -oP 'BOOTIF=01-\K[0-9a-fA-F:-]+' | tr '-' ':' | tr 'A-F' 'a-f')
if [ -z "$BOOTIF" ]; then
    # Fall back to getting MAC from the first non-lo interface
    BOOTIF=$(ip link show | grep -A1 '^[0-9]' | grep -v lo | grep link/ether | head -1 | awk '{print $2}')
fi
echo "Detected MAC address: $BOOTIF" >> /root/ks-post.log

# Download per-node litenode certificate (not bootstrap!)
# Bootstrap certificates do NOT work for LiteNode authentication
curl -s -o /etc/bcm-agent/certs/cert.pem \
  http://{{ bcm_internal_ip }}:{{ http_port }}{{ tftpboot_path }}/bcm-agent/certs/${BOOTIF}/cert.pem
curl -s -o /etc/bcm-agent/certs/cert.key \
  http://{{ bcm_internal_ip }}:{{ http_port }}{{ tftpboot_path }}/bcm-agent/certs/${BOOTIF}/cert.key
curl -s -o /etc/bcm-agent/certs/cacert.pem \
  http://{{ bcm_internal_ip }}:{{ http_port }}{{ tftpboot_path }}/bcm-agent/certs/cacert.pem

# Verify certificates were downloaded
if [ ! -s /etc/bcm-agent/certs/cert.pem ]; then
    echo "ERROR: Failed to download certificate for MAC $BOOTIF" >> /root/ks-post.log
    echo "Check that certificates were generated in prepare_bcm_agent.yml" >> /root/ks-post.log
fi

# Set proper permissions on certificates
chmod 600 /etc/bcm-agent/certs/cert.key
chmod 644 /etc/bcm-agent/certs/cert.pem
chmod 644 /etc/bcm-agent/certs/cacert.pem

# Reload systemd to pick up the new quadlet
systemctl daemon-reload

# Enable and start BCM agent service
systemctl enable bcm-agent.service
systemctl start bcm-agent.service

# Install Slurm packages if defined for this role
{% if role.install_slurm | default(false) %}
# Configure BCM repositories for Slurm
curl -s -o /etc/yum.repos.d/cm.repo http://{{ bcm_internal_ip }}:{{ http_port }}{{ tftpboot_path }}/repos/{{ rhel_repo_name }}/repoconfig/cm.repo
curl -s -o /etc/pki/rpm-gpg/RPM-GPG-KEY-cm http://{{ bcm_internal_ip }}:{{ http_port }}{{ tftpboot_path }}/repos/{{ rhel_repo_name }}/repoconfig/RPM-GPG-KEY-cm
rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-cm

dnf install -y slurm25.05-slurmd 2>&1 | tee -a /root/slurm-install.log
{% endif %}

{% if role.post_script is defined %}
{{ role.post_script }}
{% endif %}

# Set hostname from DHCP or BCM
echo "Post-installation completed for {{ role.category }} at $(date)" >> /root/install-complete.txt
%end
