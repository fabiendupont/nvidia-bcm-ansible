---
# Generate OpenShift Agent ISO on Ansible control node

- name: Install nmstate for network configuration validation
  ansible.builtin.package:
    name: nmstate
    state: present
  become: yes
  delegate_to: localhost

- name: Check current openshift-install version
  ansible.builtin.command: openshift-install version
  register: openshift_install_version_check
  changed_when: false
  failed_when: false
  delegate_to: localhost

- name: Determine if openshift-install needs update
  ansible.builtin.set_fact:
    need_openshift_install_update: "{{ openshift_install_version_check.rc != 0 or openshift_version not in openshift_install_version_check.stdout }}"

- name: Check if oc is already installed
  ansible.builtin.command: which oc
  register: oc_check
  changed_when: false
  failed_when: false
  delegate_to: localhost

- name: Download and install openshift-install client
  when: need_openshift_install_update | bool
  delegate_to: localhost
  block:
    - name: Create temporary directory for download
      ansible.builtin.tempfile:
        state: directory
        suffix: _openshift_install
      register: openshift_temp_dir

    - name: Download openshift-install tarball
      ansible.builtin.get_url:
        url: "https://mirror.openshift.com/pub/openshift-v4/clients/ocp/stable-{{ openshift_version }}/openshift-install-linux.tar.gz"
        dest: "{{ openshift_temp_dir.path }}/openshift-install-linux.tar.gz"
        mode: '0644'

    - name: Extract openshift-install
      ansible.builtin.unarchive:
        src: "{{ openshift_temp_dir.path }}/openshift-install-linux.tar.gz"
        dest: "{{ openshift_temp_dir.path }}"
        remote_src: yes

    - name: Install openshift-install to /usr/local/bin
      ansible.builtin.copy:
        src: "{{ openshift_temp_dir.path }}/openshift-install"
        dest: /usr/local/bin/openshift-install
        mode: '0755'
        remote_src: yes
      become: yes

    - name: Clean up temporary directory
      ansible.builtin.file:
        path: "{{ openshift_temp_dir.path }}"
        state: absent

- name: Download and install oc client
  when: oc_check.rc != 0
  delegate_to: localhost
  block:
    - name: Create temporary directory for oc download
      ansible.builtin.tempfile:
        state: directory
        suffix: _oc_install
      register: oc_temp_dir

    - name: Download oc tarball
      ansible.builtin.get_url:
        url: "https://mirror.openshift.com/pub/openshift-v4/clients/ocp/stable-{{ openshift_version }}/openshift-client-linux.tar.gz"
        dest: "{{ oc_temp_dir.path }}/openshift-client-linux.tar.gz"
        mode: '0644'

    - name: Extract oc
      ansible.builtin.unarchive:
        src: "{{ oc_temp_dir.path }}/openshift-client-linux.tar.gz"
        dest: "{{ oc_temp_dir.path }}"
        remote_src: yes

    - name: Install oc to /usr/local/bin
      ansible.builtin.copy:
        src: "{{ oc_temp_dir.path }}/oc"
        dest: /usr/local/bin/oc
        mode: '0755'
        remote_src: yes
      become: yes

    - name: Clean up oc temporary directory
      ansible.builtin.file:
        path: "{{ oc_temp_dir.path }}"
        state: absent

- name: Verify openshift-install version
  ansible.builtin.command: openshift-install version
  register: openshift_install_version
  changed_when: false
  delegate_to: localhost

- name: Display openshift-install version
  ansible.builtin.debug:
    msg: "{{ openshift_install_version.stdout_lines }}"

- name: Create local directory for OpenShift installer work
  ansible.builtin.file:
    path: "{{ local_installer_workdir }}"
    state: directory
    mode: '0755'
  delegate_to: localhost

- name: Check if pull secret is provided
  ansible.builtin.stat:
    path: "{{ openshift_pull_secret_path }}"
  register: pull_secret_check
  delegate_to: localhost
  when: openshift_pull_secret_path is defined

- name: Set pull secret fact from file
  ansible.builtin.set_fact:
    openshift_pull_secret: "{{ lookup('file', openshift_pull_secret_path) | trim }}"
  delegate_to: localhost
  when:
    - openshift_pull_secret_path is defined
    - pull_secret_check.stat.exists

- name: Fail if pull secret not provided
  ansible.builtin.fail:
    msg: |
      OpenShift pull secret is required but not found at {{ openshift_pull_secret_path | default('undefined') }}.

      To get your pull secret:
      1. Visit https://console.redhat.com/openshift/install/pull-secret
      2. Download the pull secret
      3. Set openshift_pull_secret_path in your inventory to point to the file

      Example:
        openshift_pull_secret_path: "/path/to/pull-secret.json"
  when: openshift_pull_secret is not defined

- name: Read BCM SSH public keys
  ansible.builtin.shell: |
    cat /root/.ssh/id_*.pub 2>/dev/null || true
  register: bcm_ssh_keys_raw
  changed_when: false

- name: Set BCM SSH keys fact
  ansible.builtin.set_fact:
    bcm_ssh_keys: "{{ bcm_ssh_keys_raw.stdout_lines | select('match', '^ssh-') | list }}"

- name: Display BCM SSH keys count
  ansible.builtin.debug:
    msg: "Found {{ bcm_ssh_keys | length }} SSH public key(s) from BCM head node"

- name: Generate install-config.yaml
  ansible.builtin.template:
    src: install-config.yaml.j2
    dest: "{{ local_installer_workdir }}/install-config.yaml"
    mode: '0600'
  delegate_to: localhost

- name: Generate agent-config.yaml
  ansible.builtin.template:
    src: agent-config.yaml.j2
    dest: "{{ local_installer_workdir }}/agent-config.yaml"
    mode: '0600'
  delegate_to: localhost

- name: Display configuration files location
  ansible.builtin.debug:
    msg:
      - "Install config: {{ local_installer_workdir }}/install-config.yaml"
      - "Agent config: {{ local_installer_workdir }}/agent-config.yaml"

- name: Check if agent ISO already exists
  ansible.builtin.stat:
    path: "{{ local_installer_workdir }}/agent.x86_64.iso"
  register: agent_iso_check
  delegate_to: localhost

- name: Generate agent ISO
  ansible.builtin.command:
    cmd: openshift-install agent create image
    chdir: "{{ local_installer_workdir }}"
  delegate_to: localhost
  when: not agent_iso_check.stat.exists
  register: iso_creation

- name: Display ISO creation output
  ansible.builtin.debug:
    msg: "{{ iso_creation.stdout_lines }}"
  when: iso_creation is defined and iso_creation.changed

- name: Verify agent ISO was created
  ansible.builtin.stat:
    path: "{{ local_installer_workdir }}/agent.x86_64.iso"
  register: agent_iso_verify
  delegate_to: localhost

- name: Fail if ISO not created
  ansible.builtin.fail:
    msg: "Agent ISO was not created at {{ local_installer_workdir }}/agent.x86_64.iso"
  when: not agent_iso_verify.stat.exists

- name: Display agent ISO information
  ansible.builtin.debug:
    msg:
      - "Agent ISO created successfully"
      - "Location: {{ local_installer_workdir }}/agent.x86_64.iso"
      - "Size: {{ (agent_iso_verify.stat.size / 1024 / 1024) | round(2) }} MB"

- name: Check if PXE files already exist
  ansible.builtin.stat:
    path: "{{ local_installer_workdir }}/boot-artifacts/agent.x86_64-rootfs.img"
  register: pxe_files_check
  delegate_to: localhost

- name: Generate PXE boot files using openshift-install
  ansible.builtin.command:
    cmd: openshift-install agent create pxe-files
    chdir: "{{ local_installer_workdir }}"
  delegate_to: localhost
  when: not pxe_files_check.stat.exists
  register: pxe_creation

- name: Display PXE files creation output
  ansible.builtin.debug:
    msg: "{{ pxe_creation.stdout_lines }}"
  when: pxe_creation is defined and pxe_creation.changed

- name: Verify PXE vmlinuz was created
  ansible.builtin.stat:
    path: "{{ local_installer_workdir }}/boot-artifacts/agent.x86_64-vmlinuz"
  register: pxe_vmlinuz
  failed_when: not pxe_vmlinuz.stat.exists
  delegate_to: localhost

- name: Verify PXE initrd was created
  ansible.builtin.stat:
    path: "{{ local_installer_workdir }}/boot-artifacts/agent.x86_64-initrd.img"
  register: pxe_initrd
  failed_when: not pxe_initrd.stat.exists
  delegate_to: localhost

- name: Verify PXE rootfs was created
  ansible.builtin.stat:
    path: "{{ local_installer_workdir }}/boot-artifacts/agent.x86_64-rootfs.img"
  register: pxe_rootfs
  failed_when: not pxe_rootfs.stat.exists
  delegate_to: localhost

- name: Display PXE boot artifacts information
  ansible.builtin.debug:
    msg:
      - "PXE boot files generated successfully"
      - "Location: {{ local_installer_workdir }}/boot-artifacts/"
      - "vmlinuz: {{ (pxe_vmlinuz.stat.size / 1024 / 1024) | round(2) }} MB"
      - "initrd: {{ (pxe_initrd.stat.size / 1024 / 1024) | round(2) }} MB (with agent installer)"
      - "rootfs: {{ (pxe_rootfs.stat.size / 1024 / 1024) | round(2) }} MB"

- name: Copy agent ISO to BCM head node
  ansible.builtin.copy:
    src: "{{ local_installer_workdir }}/agent.x86_64.iso"
    dest: "{{ openshift_iso_path }}"
    mode: '0644'

- name: Verify ISO on BCM head node
  ansible.builtin.stat:
    path: "{{ openshift_iso_path }}"
  register: bcm_iso_verify

- name: Display BCM ISO information
  ansible.builtin.debug:
    msg:
      - "Agent ISO copied to BCM head node successfully"
      - "Location: {{ openshift_iso_path }}"
      - "Size: {{ (bcm_iso_verify.stat.size / 1024 / 1024) | round(2) }} MB"
