---
# Deploy BCM agent via Helm chart after LiteNode conversion
# This enables persistent agent-based management of OpenShift nodes
#
# Note: LiteNode conversion is handled by deploy_bcm_daemon.yml before
# this task file is included. If calling this directly, ensure nodes are
# already converted to LiteNodes.

- name: Set registry variables defaults
  ansible.builtin.set_fact:
    registry_hostname: "{{ registry_hostname | default(ansible_fqdn) }}"
    registry_port: "{{ registry_port | default(5000) }}"

# Generate per-node litenode certificates using shared role
- name: Generate litenode certificates for cluster nodes
  ansible.builtin.include_role:
    name: litenode_certificates
  vars:
    litenode_certs_dir: "/openshift/clusters/{{ cluster_name }}/node_certs"

- name: Read BCM CA certificate
  ansible.builtin.slurp:
    src: "/cm/local/apps/cmd/etc/cacert.pem"
  register: bcm_ca_cert_b64

- name: Check if BCM agent image exists locally
  containers.podman.podman_image_info:
    name: "localhost/bcm-agent:{{ bcm_agent_local_tag }}"
  register: local_image_info

- name: Fail if local image not found
  ansible.builtin.fail:
    msg: |
      BCM agent image not found locally: localhost/bcm-agent:{{ bcm_agent_local_tag }}
      Please build the image first using build_bcm_agent_image.yml playbook.
  when: local_image_info.images | length == 0

- name: Tag image for registry
  containers.podman.podman_tag:
    image: "localhost/bcm-agent:{{ bcm_agent_local_tag }}"
    target_names:
      - "{{ registry_hostname }}:{{ registry_port }}/bcm-agent:{{ bcm_agent_local_tag }}"

- name: Push image to BCM registry
  containers.podman.podman_image:
    name: "{{ registry_hostname }}:{{ registry_port }}/bcm-agent"
    tag: "{{ bcm_agent_local_tag }}"
    push: true
    validate_certs: false
  register: image_push
  retries: 3
  delay: 5

- name: Display image push status
  ansible.builtin.debug:
    msg: "Pushed bcm-agent:{{ bcm_agent_local_tag }} to {{ registry_hostname }}:{{ registry_port }}"

- name: Create bcm-agent namespace
  kubernetes.core.k8s:
    api_version: v1
    kind: Namespace
    name: "{{ bcm_agent_namespace }}"
    state: present
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"

- name: Grant privileged SCC to bcm-agent ServiceAccount
  ansible.builtin.command:
    cmd: "/openshift/tools/{{ openshift_version }}/oc adm policy add-scc-to-user privileged -z bcm-agent -n {{ bcm_agent_namespace }}"
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
  register: scc_result
  changed_when: "'added' in scc_result.stdout or 'already has' not in scc_result.stdout"

- name: Read per-node litenode certificates
  ansible.builtin.slurp:
    src: "/openshift/clusters/{{ cluster_name }}/node_certs/{{ item.name }}.pem"
  loop: "{{ cluster_nodes }}"
  loop_control:
    label: "{{ item.name }}"
  register: litenode_certs

- name: Read per-node litenode keys
  ansible.builtin.slurp:
    src: "/openshift/clusters/{{ cluster_name }}/node_certs/{{ item.name }}.key"
  loop: "{{ cluster_nodes }}"
  loop_control:
    label: "{{ item.name }}"
  register: litenode_keys

- name: Build certificate data dictionary
  ansible.builtin.set_fact:
    cert_data: "{{ cert_data | default({}) | combine({item.0.item.name ~ '-cert.pem': item.0.content, item.0.item.name ~ '-cert.key': item.1.content}) }}"
  loop: "{{ litenode_certs.results | zip(litenode_keys.results) | list }}"
  loop_control:
    label: "{{ item.0.item.name }}"

- name: Create BCM litenode certificates Secret with all per-node certs
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: bcm-litenode-certs
        namespace: "{{ bcm_agent_namespace }}"
      type: Opaque
      data: "{{ cert_data | combine({'cacert.pem': bcm_ca_cert_b64.content}) }}"
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"

- name: Deploy bcm-agent Helm chart
  kubernetes.core.helm:
    name: bcm-agent
    chart_ref: "{{ bcm_agent_helm_chart_path }}"
    release_namespace: "{{ bcm_agent_namespace }}"
    create_namespace: false
    values:
      image:
        repository: "{{ registry_hostname }}:{{ registry_port }}/bcm-agent"
        tag: "{{ bcm_agent_local_tag }}"
        pullPolicy: IfNotPresent
      config:
        bcm:
          host: "{{ bcm_server }}"
          port: 8081
        kubernetes:
          syncInterval: 300
          labelPrefix: "bcm.nvidia.com"
          enableLabeling: true
      certificates:
        secretName: bcm-litenode-certs
        # Container will select cert files matching hostname (e.g., sno-master-0-cert.pem)
      resources:
        requests:
          memory: "256Mi"
          cpu: "100m"
        limits:
          memory: "512Mi"
          cpu: "500m"
      metrics:
        enabled: true
        port: 9100
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"

- name: Patch DaemonSet with initContainer to select per-node certificate
  kubernetes.core.k8s:
    state: patched
    kind: DaemonSet
    name: bcm-agent
    namespace: "{{ bcm_agent_namespace }}"
    definition:
      spec:
        template:
          spec:
            containers:
              - name: bcm-agent
                volumeMounts:
                  - name: bcm-certs
                    mountPath: /etc/bcm-agent/certs
                    readOnly: true
            initContainers:
              - name: select-node-cert
                image: "{{ registry_hostname }}:{{ registry_port }}/bcm-agent:{{ bcm_agent_local_tag }}"
                command:
                  - /bin/sh
                  - -c
                  - |
                    cp /etc/bcm-certs-all/cacert.pem /etc/bcm-agent/certs/cacert.pem
                    cp /etc/bcm-certs-all/${NODE_NAME}-cert.pem /etc/bcm-agent/certs/cert.pem
                    cp /etc/bcm-certs-all/${NODE_NAME}-cert.key /etc/bcm-agent/certs/cert.key
                    chmod 600 /etc/bcm-agent/certs/cert.key
                env:
                  - name: NODE_NAME
                    valueFrom:
                      fieldRef:
                        fieldPath: spec.nodeName
                volumeMounts:
                  - name: bcm-certs-all
                    mountPath: /etc/bcm-certs-all
                    readOnly: true
                  - name: bcm-certs
                    mountPath: /etc/bcm-agent/certs
            volumes:
              - name: bcm-certs-all
                secret:
                  secretName: bcm-litenode-certs
              - name: bcm-certs
                emptyDir: {}
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"

- name: Wait for bcm-agent DaemonSet to be ready
  ansible.builtin.command:
    cmd: "/openshift/tools/{{ openshift_version }}/oc rollout status daemonset/bcm-agent -n {{ bcm_agent_namespace }} --timeout=5m"
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
  register: daemonset_status
  changed_when: false

- name: Display agent deployment status
  ansible.builtin.debug:
    msg: "BCM agent deployed successfully across {{ cluster_nodes | length }} nodes"

- name: Verify agent connectivity to BCM
  ansible.builtin.pause:
    seconds: 30
    prompt: "Waiting for agents to connect to BCM..."

- name: Check LiteNode status in BCM
  brightcomputing.bcm110.lite_node_info:
    hostname: "{{ item.name }}"
  loop: "{{ cluster_nodes }}"
  loop_control:
    label: "{{ item.name }}"
  register: litenode_connectivity

- name: Display connectivity status
  ansible.builtin.debug:
    msg: "{{ item.item.name }}: {{ item.lite_node.status | default('unknown') }}"
  loop: "{{ litenode_connectivity.results }}"
  loop_control:
    label: "{{ item.item.name }}"
  when: item.lite_node is defined
