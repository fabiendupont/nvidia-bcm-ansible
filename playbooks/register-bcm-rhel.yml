---
# Register bcm-rhel VM with BCM and deploy BCM Agent
#
# This playbook:
#   1. Installs Podman and dependencies
#   2. Registers the VM as a node in BCM
#   3. Deploys BCM Agent on the VM
#
# Usage:
#   ansible-playbook -i bcm-rhel-inventory.yml register-bcm-rhel.yml

- name: Prepare bcm-rhel VM
  hosts: bcm-rhel
  become: true
  gather_facts: true

  tasks:
    - name: Display VM information
      ansible.builtin.debug:
        msg:
          - "========================================="
          - "Preparing bcm-rhel for BCM registration"
          - "========================================="
          - "Hostname: {{ ansible_hostname }}"
          - "IP: {{ vm_ip }}"
          - "MAC: {{ vm_mac }}"
          - "OS: {{ ansible_distribution }} {{ ansible_distribution_version }}"
          - ""

    - name: Check if Podman is installed
      ansible.builtin.command: podman --version
      register: podman_check
      failed_when: false
      changed_when: false

    - name: Install Podman and dependencies
      ansible.builtin.dnf:
        name:
          - podman
          - podman-plugins
          - containers-common
        state: present
      when: podman_check.rc != 0

    - name: Verify Podman installation
      ansible.builtin.command: podman --version
      register: podman_version
      changed_when: false

    - name: Display Podman version
      ansible.builtin.debug:
        msg: "Podman installed: {{ podman_version.stdout }}"

    - name: Install additional utilities
      ansible.builtin.dnf:
        name:
          - ipmitool
          - dmidecode
          - pciutils
          - net-tools
        state: present

- name: Register bcm-rhel with BCM
  hosts: bcm-rhel
  gather_facts: false

  tasks:
    - name: Query node in BCM
      nvidia.bcm.bcm_node:
        name: "{{ bcm_node_name }}"
        state: query
      delegate_to: localhost
      register: bcm_node_query
      run_once: true

    - name: Display BCM node status
      ansible.builtin.debug:
        msg: "Node {{ bcm_node_name }} {{ 'exists' if bcm_node_query.node else 'does not exist' }} in BCM"
      run_once: true

    - name: Display node details
      ansible.builtin.debug:
        var: bcm_node_query.node
      when: bcm_node_query.node
      run_once: true

- name: Copy BCM certificates to bcm-rhel
  hosts: bcm-rhel
  become: true
  gather_facts: false

  tasks:
    - name: Create certificate directory on bcm-rhel
      ansible.builtin.file:
        path: /etc/bcm-agent-certs
        state: directory
        mode: '0755'

    - name: Copy certificates from BCM head node to bcm-rhel
      ansible.builtin.copy:
        src: "/cm/local/apps/cmd/etc/{{ item }}"
        dest: "/etc/bcm-agent-certs/{{ item }}"
        mode: "{{ '0400' if item == 'cert.key' else '0444' }}"
      loop:
        - cacert.pem
        - cert.pem
        - cert.key

- name: Deploy BCM Agent
  hosts: bcm-rhel
  become: true
  gather_facts: true

  pre_tasks:
    - name: Display BCM Agent deployment info
      ansible.builtin.debug:
        msg:
          - "========================================="
          - "Deploying BCM Agent"
          - "=========================================  "
          - "Target: {{ ansible_hostname }}"
          - "BCM Host: {{ bcm_agent_bcm_host }}:{{ bcm_agent_bcm_port }}"
          - "Image: {{ bcm_agent_image_repository }}:{{ bcm_agent_image_tag }}"
          - ""

  roles:
    - role: ../roles/bcm_agent
      vars:
        bcm_agent_image: "{{ bcm_agent_image_repository }}:{{ bcm_agent_image_tag }}"

  post_tasks:
    - name: Wait for BCM Agent to start
      ansible.builtin.pause:
        seconds: 15

    - name: Check BCM Agent service status
      ansible.builtin.systemd:
        name: bcm-agent.service
      register: service_status

    - name: Verify cm-lite-daemon is running
      ansible.builtin.shell: |
        podman exec bcm-agent test -f /var/run/bcm-agent/cm-lite-daemon.pid && \
        podman exec bcm-agent cat /var/run/bcm-agent/cm-lite-daemon.pid
      register: daemon_pid
      failed_when: false
      changed_when: false

    - name: Check Prometheus metrics
      ansible.builtin.uri:
        url: "http://localhost:{{ bcm_agent_metrics_port | default(9100) }}/metrics"
        return_content: false
        status_code: 200
      register: metrics_check
      failed_when: false
      changed_when: false

    - name: Display deployment summary
      ansible.builtin.debug:
        msg:
          - "========================================="
          - "BCM Registration and Deployment Complete"
          - "========================================="
          - ""
          - "Node Details:"
          - "  Name: {{ bcm_node_name }}"
          - "  IP: {{ vm_ip }}"
          - "  MAC: {{ vm_mac }}"
          - "  Roles: {{ bcm_node_roles | join(', ') }}"
          - ""
          - "BCM Agent:"
          - "  Service: {{ service_status.status.ActiveState }}"
          - "  cm-lite-daemon PID: {{ daemon_pid.stdout if daemon_pid.rc == 0 else 'Not yet running' }}"
          - "  Metrics: {{ 'Available' if metrics_check.status == 200 else 'Starting up...' }}"
          - ""
          - "Verification Commands:"
          - "  # On BCM head node:"
          - "  cmsh -c 'device; show {{ bcm_node_name }}'"
          - ""
          - "  # On bcm-rhel VM:"
          - "  systemctl status bcm-agent.service"
          - "  journalctl -u bcm-agent.service -f"
          - "  podman logs bcm-agent"
          - "  curl http://localhost:9100/metrics"
          - "  tail -f /var/log/bcm-agent/cm-lite-daemon.log"
          - ""
