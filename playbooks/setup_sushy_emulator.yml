---
# Setup sushy-tools Redfish emulator for VM testing
#
# This playbook sets up sushy-tools to provide Redfish API emulation for libvirt VMs.
# This allows testing BCM Redfish integration without physical hardware.
#
# Usage:
#   ansible-playbook playbooks/setup_sushy_emulator.yml
#
# Prerequisites:
#   - libvirt/KVM installed and running
#   - Podman installed
#   - VMs created (can be powered off)

- name: Setup Sushy-Tools Redfish Emulator (Containerized)
  hosts: localhost
  become: true
  gather_facts: true

  vars:
    sushy_port: 8000
    sushy_listen_ip: "0.0.0.0"
    sushy_config_dir: "/etc/sushy-emulator"
    libvirt_uri: "qemu:///system"
    sushy_container_image: "quay.io/metal3-io/sushy-tools:latest"

  tasks:
    - name: Display setup information
      ansible.builtin.debug:
        msg:
          - "================================================================"
          - "Setting up Sushy-Tools Redfish Emulator (Containerized)"
          - "================================================================"
          - "Port: {{ sushy_port }}"
          - "Listen IP: {{ sushy_listen_ip }}"
          - "Libvirt URI: {{ libvirt_uri }}"
          - "Container Image: {{ sushy_container_image }}"
          - "================================================================"

    - name: Ensure podman is installed
      ansible.builtin.package:
        name: podman
        state: present

    - name: Create sushy config directory
      ansible.builtin.file:
        path: "{{ sushy_config_dir }}"
        state: directory
        mode: '0755'

    - name: Create sushy-emulator configuration file
      ansible.builtin.copy:
        content: |
          SUSHY_EMULATOR_LISTEN_IP = "{{ sushy_listen_ip }}"
          SUSHY_EMULATOR_LISTEN_PORT = {{ sushy_port }}
          SUSHY_EMULATOR_LIBVIRT_URI = "{{ libvirt_uri }}"
        dest: "{{ sushy_config_dir }}/sushy-emulator.conf"
        mode: '0644'

    - name: Pull sushy-tools container image
      containers.podman.podman_image:
        name: "{{ sushy_container_image }}"
        state: present

    - name: Create systemd service file for sushy-emulator
      ansible.builtin.copy:
        content: |
          [Unit]
          Description=Sushy Redfish Emulator for Libvirt
          After=network-online.target libvirtd.service
          Wants=network-online.target

          [Service]
          Type=simple
          Restart=always
          RestartSec=10
          ExecStartPre=-/usr/bin/podman kill sushy-emulator
          ExecStartPre=-/usr/bin/podman rm sushy-emulator
          ExecStart=/usr/bin/podman run --rm --name sushy-emulator \
            --net=host \
            --privileged \
            -v /var/run/libvirt:/var/run/libvirt:Z \
            -v {{ sushy_config_dir }}/sushy-emulator.conf:{{ sushy_config_dir }}/sushy-emulator.conf:ro,Z \
            {{ sushy_container_image }} \
            sushy-emulator --config {{ sushy_config_dir }}/sushy-emulator.conf
          ExecStop=/usr/bin/podman stop sushy-emulator

          [Install]
          WantedBy=multi-user.target
        dest: /etc/systemd/system/sushy-emulator.service
        mode: '0644'

    - name: Reload systemd daemon
      ansible.builtin.systemd:
        daemon_reload: true

    - name: Enable and start sushy-emulator service
      ansible.builtin.systemd:
        name: sushy-emulator
        enabled: true
        state: restarted

    - name: Wait for sushy-emulator to be ready
      ansible.builtin.wait_for:
        port: "{{ sushy_port }}"
        host: "127.0.0.1"
        timeout: 30

    - name: Configure firewall for libvirt zone (firewalld)
      ansible.posix.firewalld:
        zone: libvirt
        port: "{{ sushy_port }}/tcp"
        permanent: true
        state: enabled
        immediate: true
      when:
        - ansible_facts.services['firewalld.service'] is defined
        - ansible_facts.services['firewalld.service'].state == 'running'
      failed_when: false

    - name: Test Redfish API endpoint
      ansible.builtin.uri:
        url: "http://127.0.0.1:{{ sushy_port }}/redfish/v1/"
        method: GET
        status_code: 200
      register: redfish_test
      failed_when: false

    - name: Display Redfish API response
      ansible.builtin.debug:
        msg: "{{ redfish_test.json }}"
      when: redfish_test.status == 200

    - name: List available systems (VMs)
      ansible.builtin.uri:
        url: "http://127.0.0.1:{{ sushy_port }}/redfish/v1/Systems"
        method: GET
        status_code: 200
      register: systems_list
      failed_when: false

    - name: Get list of all libvirt VMs with UUIDs
      ansible.builtin.shell: |
        for vm in $(virsh list --all --name); do
          if [ -n "$vm" ]; then
            uuid=$(virsh domuuid "$vm")
            echo "$vm: $uuid"
          fi
        done
      register: vm_uuids
      changed_when: false

    - name: Display available VMs and their Redfish URLs
      ansible.builtin.debug:
        msg:
          - "================================================================"
          - "Sushy-Tools Redfish Emulator Setup Complete!"
          - "================================================================"
          - "Redfish API Base URL: http://{{ ansible_default_ipv4.address }}:{{ sushy_port }}/redfish/v1/"
          - "Systems Endpoint: http://{{ ansible_default_ipv4.address }}:{{ sushy_port }}/redfish/v1/Systems"
          - ""
          - "Available VMs:"
          - "{{ vm_uuids.stdout_lines }}"
          - ""
          - "Service Management:"
          - "  sudo systemctl status sushy-emulator"
          - "  sudo systemctl restart sushy-emulator"
          - "  sudo journalctl -u sushy-emulator -f"
          - ""
          - "Test Redfish API:"
          - "  curl http://{{ ansible_default_ipv4.address }}:{{ sushy_port }}/redfish/v1/"
          - "  curl http://{{ ansible_default_ipv4.address }}:{{ sushy_port }}/redfish/v1/Systems"
          - ""
          - "For BCM integration, use these Redfish system endpoints:"
          - "  http://{{ ansible_default_ipv4.address }}:{{ sushy_port }}/redfish/v1/Systems/<vm-uuid>"
          - "================================================================"
