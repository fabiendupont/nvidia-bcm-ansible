---
# Setup sushy-tools Redfish emulator for VM testing
#
# This playbook sets up sushy-tools to provide Redfish API emulation for libvirt VMs.
# This allows testing BCM Redfish integration without physical hardware.
#
# Usage:
#   ansible-playbook playbooks/setup_sushy_emulator.yml
#
# Prerequisites:
#   - libvirt/KVM installed and running
#   - VMs created (can be powered off)
#   - Python 3.8+

- name: Setup Sushy-Tools Redfish Emulator
  hosts: localhost
  become: true
  gather_facts: true

  vars:
    sushy_port: 8000
    sushy_listen_ip: "0.0.0.0"
    sushy_user: "admin"
    sushy_password: "password"
    sushy_install_dir: "/opt/sushy-tools"
    sushy_config_dir: "/etc/sushy"
    sushy_log_dir: "/var/log/sushy"
    libvirt_uri: "qemu:///system"

  tasks:
    - name: Display setup information
      ansible.builtin.debug:
        msg:
          - "================================================================"
          - "Setting up Sushy-Tools Redfish Emulator"
          - "================================================================"
          - "Port: {{ sushy_port }}"
          - "Listen IP: {{ sushy_listen_ip }}"
          - "Libvirt URI: {{ libvirt_uri }}"
          - "================================================================"

    - name: Install required packages
      ansible.builtin.package:
        name:
          - python3-pip
          - python3-libvirt
          - libvirt-daemon-system
          - qemu-kvm
        state: present

    - name: Create sushy directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - "{{ sushy_install_dir }}"
        - "{{ sushy_config_dir }}"
        - "{{ sushy_log_dir }}"

    - name: Install sushy-tools via pip
      ansible.builtin.pip:
        name: sushy-tools
        state: present
        executable: pip3

    - name: Create sushy-emulator configuration
      ansible.builtin.copy:
        content: |
          # Sushy-tools Redfish Emulator Configuration
          # Generated by Ansible for BCM testing

          # Listen address and port
          SUSHY_EMULATOR_LISTEN_IP = '{{ sushy_listen_ip }}'
          SUSHY_EMULATOR_LISTEN_PORT = {{ sushy_port }}

          # Libvirt connection
          SUSHY_EMULATOR_LIBVIRT_URI = '{{ libvirt_uri }}'

          # Authentication (optional, uncomment to enable)
          # SUSHY_EMULATOR_AUTH_FILE = '{{ sushy_config_dir }}/auth.conf'

          # SSL/TLS (optional, for production use)
          # SUSHY_EMULATOR_SSL_CERT = '/etc/sushy/cert.pem'
          # SUSHY_EMULATOR_SSL_KEY = '/etc/sushy/key.pem'

          # Logging
          SUSHY_EMULATOR_LOG_FILE = '{{ sushy_log_dir }}/sushy-emulator.log'

          # Redfish API version
          SUSHY_EMULATOR_REDFISH_VERSION = '1.8.0'

          # Allow boot device override (needed for PXE boot control)
          SUSHY_EMULATOR_BOOT_LOADER_MAP = {
              'Pxe': {
                  'Cd': 'hd',
                  'Hdd': 'hd',
                  'Pxe': 'network'
              }
          }

          # Ignore boot device on VM create (use existing VM config)
          SUSHY_EMULATOR_IGNORE_BOOT_DEVICE = False
        dest: "{{ sushy_config_dir }}/sushy-emulator.conf"
        mode: '0644'

    - name: Create authentication file (optional)
      ansible.builtin.copy:
        content: |
          {{ sushy_user }}:{{ sushy_password }}
        dest: "{{ sushy_config_dir }}/auth.conf"
        mode: '0600'

    - name: Create systemd service file
      ansible.builtin.copy:
        content: |
          [Unit]
          Description=Sushy Redfish Emulator
          After=network.target libvirtd.service
          Requires=libvirtd.service

          [Service]
          Type=simple
          User=root
          Group=root
          Environment="SUSHY_EMULATOR_CONFIG={{ sushy_config_dir }}/sushy-emulator.conf"
          ExecStart=/usr/local/bin/sushy-emulator
          Restart=on-failure
          RestartSec=10
          StandardOutput=journal
          StandardError=journal

          [Install]
          WantedBy=multi-user.target
        dest: /etc/systemd/system/sushy-emulator.service
        mode: '0644'

    - name: Reload systemd daemon
      ansible.builtin.systemd:
        daemon_reload: true

    - name: Enable and start sushy-emulator service
      ansible.builtin.systemd:
        name: sushy-emulator
        enabled: true
        state: started

    - name: Wait for sushy-emulator to be ready
      ansible.builtin.wait_for:
        port: "{{ sushy_port }}"
        host: "{{ sushy_listen_ip if sushy_listen_ip != '0.0.0.0' else '127.0.0.1' }}"
        timeout: 30

    - name: Test Redfish API endpoint
      ansible.builtin.uri:
        url: "http://127.0.0.1:{{ sushy_port }}/redfish/v1/"
        method: GET
        status_code: 200
      register: redfish_test
      failed_when: false

    - name: Display Redfish API response
      ansible.builtin.debug:
        msg: "{{ redfish_test.json }}"
      when: redfish_test.status == 200

    - name: List available systems (VMs)
      ansible.builtin.uri:
        url: "http://127.0.0.1:{{ sushy_port }}/redfish/v1/Systems"
        method: GET
        status_code: 200
      register: systems_list
      failed_when: false

    - name: Display available VMs
      ansible.builtin.debug:
        msg: "{{ systems_list.json }}"
      when: systems_list.status == 200

    - name: Create firewall rule for sushy-emulator (firewalld)
      ansible.posix.firewalld:
        port: "{{ sushy_port }}/tcp"
        permanent: true
        state: enabled
        immediate: true
      when: ansible_facts.services['firewalld.service'] is defined
      failed_when: false

    - name: Create firewall rule for sushy-emulator (ufw)
      community.general.ufw:
        rule: allow
        port: "{{ sushy_port }}"
        proto: tcp
      when: ansible_facts.services['ufw.service'] is defined
      failed_when: false

    - name: Display setup summary
      ansible.builtin.debug:
        msg:
          - "================================================================"
          - "Sushy-Tools Redfish Emulator Setup Complete!"
          - "================================================================"
          - "Redfish API Base URL: http://{{ ansible_default_ipv4.address }}:{{ sushy_port }}/redfish/v1/"
          - "Systems Endpoint: http://{{ ansible_default_ipv4.address }}:{{ sushy_port }}/redfish/v1/Systems"
          - ""
          - "Service Status:"
          - "  systemctl status sushy-emulator"
          - ""
          - "View Logs:"
          - "  journalctl -u sushy-emulator -f"
          - "  tail -f {{ sushy_log_dir }}/sushy-emulator.log"
          - ""
          - "Test Redfish API:"
          - "  curl http://{{ ansible_default_ipv4.address }}:{{ sushy_port }}/redfish/v1/"
          - ""
          - "List VMs (Systems):"
          - "  curl http://{{ ansible_default_ipv4.address }}:{{ sushy_port }}/redfish/v1/Systems"
          - ""
          - "VM Redfish URLs (for BCM configuration):"
          - "  Each VM will be available at:"
          - "  http://{{ ansible_default_ipv4.address }}:{{ sushy_port }}/redfish/v1/Systems/<vm-uuid>"
          - ""
          - "Next Steps:"
          - "  1. List your VMs: virsh list --all"
          - "  2. Get VM UUIDs: virsh domuuid <vm-name>"
          - "  3. Configure BCM nodes with Redfish BMC addresses"
          - "  4. Test power control via bcm_power module"
          - "================================================================"

    - name: Save configuration summary
      ansible.builtin.copy:
        content: |
          # Sushy-Tools Redfish Emulator Configuration Summary

          ## Service Information
          - Status: Running
          - Port: {{ sushy_port }}
          - Listen Address: {{ sushy_listen_ip }}
          - Redfish API: http://{{ ansible_default_ipv4.address }}:{{ sushy_port }}/redfish/v1/

          ## Configuration Files
          - Config: {{ sushy_config_dir }}/sushy-emulator.conf
          - Auth: {{ sushy_config_dir }}/auth.conf
          - Service: /etc/systemd/system/sushy-emulator.service
          - Logs: {{ sushy_log_dir }}/sushy-emulator.log

          ## Libvirt Integration
          - URI: {{ libvirt_uri }}
          - Each libvirt VM appears as a Redfish System
          - VM UUID maps to System ID

          ## Testing Commands

          ### Check service status
          ```bash
          systemctl status sushy-emulator
          journalctl -u sushy-emulator -f
          ```

          ### Test Redfish API
          ```bash
          # Service root
          curl http://{{ ansible_default_ipv4.address }}:{{ sushy_port }}/redfish/v1/

          # List all systems (VMs)
          curl http://{{ ansible_default_ipv4.address }}:{{ sushy_port }}/redfish/v1/Systems

          # Get specific VM (replace UUID)
          curl http://{{ ansible_default_ipv4.address }}:{{ sushy_port }}/redfish/v1/Systems/<vm-uuid>
          ```

          ### Get VM UUIDs
          ```bash
          # List all VMs
          virsh list --all

          # Get UUID for specific VM
          virsh domuuid <vm-name>
          ```

          ### Power control via Redfish (example)
          ```bash
          # Power on VM
          curl -X POST http://{{ ansible_default_ipv4.address }}:{{ sushy_port }}/redfish/v1/Systems/<vm-uuid>/Actions/ComputerSystem.Reset \
            -H "Content-Type: application/json" \
            -d '{"ResetType": "On"}'

          # Power off VM
          curl -X POST http://{{ ansible_default_ipv4.address }}:{{ sushy_port }}/redfish/v1/Systems/<vm-uuid>/Actions/ComputerSystem.Reset \
            -H "Content-Type: application/json" \
            -d '{"ResetType": "GracefulShutdown"}'

          # Force off
          curl -X POST http://{{ ansible_default_ipv4.address }}:{{ sushy_port }}/redfish/v1/Systems/<vm-uuid>/Actions/ComputerSystem.Reset \
            -H "Content-Type: application/json" \
            -d '{"ResetType": "ForceOff"}'
          ```

          ## BCM Configuration

          For each VM, configure BCM with the Redfish endpoint:

          ```bash
          # Get VM UUID
          VM_NAME="worker-1"
          VM_UUID=$(virsh domuuid $VM_NAME)

          # Configure in BCM
          cmsh -c "device use $VM_NAME; set bmc {{ ansible_default_ipv4.address }}:{{ sushy_port }}/redfish/v1/Systems/$VM_UUID"
          ```

          ## Ansible Integration

          Use the bcm_power module with Redfish:

          ```yaml
          - name: Power on VM via Redfish
            nvidia.bcm.bcm_power:
              name: worker-1
              state: on
          ```

          ## Troubleshooting

          ### Service won't start
          - Check libvirtd is running: `systemctl status libvirtd`
          - Check logs: `journalctl -u sushy-emulator -n 50`

          ### VMs not appearing
          - Verify libvirt connection: `virsh -c {{ libvirt_uri }} list --all`
          - Check sushy logs: `tail -f {{ sushy_log_dir }}/sushy-emulator.log`

          ### Power operations fail
          - Verify VM exists: `virsh list --all`
          - Check VM UUID matches: `virsh domuuid <vm-name>`
          - Test direct Redfish API call (see examples above)

          ## Authentication (Optional)

          To enable authentication, uncomment in {{ sushy_config_dir }}/sushy-emulator.conf:
          ```python
          SUSHY_EMULATOR_AUTH_FILE = '{{ sushy_config_dir }}/auth.conf'
          ```

          Then restart: `systemctl restart sushy-emulator`

          Use credentials in API calls:
          ```bash
          curl -u {{ sushy_user }}:{{ sushy_password }} http://...
          ```
        dest: "/root/sushy-emulator-setup.md"
        mode: '0644'
