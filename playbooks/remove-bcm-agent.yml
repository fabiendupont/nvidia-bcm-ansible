---
# Remove BCM Agent from compute nodes
#
# Usage:
#   ansible-playbook -i inventory.yml remove-bcm-agent.yml
#
# Remove from specific host:
#   ansible-playbook -i inventory.yml remove-bcm-agent.yml --limit node001
#
# Also remove container image:
#   ansible-playbook -i inventory.yml remove-bcm-agent.yml -e bcm_agent_remove_image=true

- name: Remove BCM Agent
  hosts: all
  become: true
  gather_facts: true

  pre_tasks:
    - name: Confirm removal
      ansible.builtin.pause:
        prompt: |
          WARNING: This will remove BCM Agent from the following hosts:
          {{ ansible_play_hosts | join(', ') }}

          Press Enter to continue or Ctrl+C to abort
      run_once: true
      when: not (auto_confirm | default(false) | bool)

    - name: Display removal information
      ansible.builtin.debug:
        msg:
          - "Removing BCM Agent from: {{ ansible_hostname }}"
          - "Remove image: {{ bcm_agent_remove_image | default(false) }}"

  roles:
    - role: nvidia.bcm.bcm_agent
      vars:
        bcm_agent_state: "absent"

  post_tasks:
    - name: Verify service is stopped
      ansible.builtin.systemd:
        name: bcm-agent.service
      register: service_status
      failed_when: false

    - name: Display removal summary
      ansible.builtin.debug:
        msg:
          - "BCM Agent removed from {{ ansible_hostname }}"
          - "Service state: {{ service_status.status.ActiveState | default('not found') }}"
