---
###############################################################################
# Cleanup RHEL 9.6 PXE Test
###############################################################################

- name: Cleanup RHEL 9.6 PXE test environment
  hosts: localhost
  gather_facts: no
  become: yes

  vars:
    vm_name: "rhel96-test"
    category_name: "rhel96-test"
    rhel_mount_path: "/mnt/rhel96-iso"

  tasks:
    - name: Remove node from BCM
      nvidia.bcm.bcm_node:
        name: "{{ vm_name }}"
        state: absent
      ignore_errors: yes

    - name: Remove category from BCM
      nvidia.bcm.bcm_category:
        name: "{{ category_name }}"
        state: absent
      ignore_errors: yes

    - name: Unmount RHEL ISO
      ansible.posix.mount:
        path: "{{ rhel_mount_path }}"
        state: unmounted
      ignore_errors: yes

    - name: Remove HTTP mirror symlink
      ansible.builtin.file:
        path: /var/www/html/rhel96
        state: absent

    - name: Remove kickstart file
      ansible.builtin.file:
        path: /var/www/html/ks/rhel96-test.cfg
        state: absent

    - name: Remove PXE boot files
      ansible.builtin.file:
        path: /tftpboot/images/rhel96-test
        state: absent

    - name: Remove category PXE config
      ansible.builtin.file:
        path: /tftpboot/x86_64/bios/pxelinux.cfg/category.rhel96-test
        state: absent

    - name: Remove ISO mount point
      ansible.builtin.file:
        path: "{{ rhel_mount_path }}"
        state: absent

    - name: Cleanup complete
      ansible.builtin.debug:
        msg:
          - "=========================================="
          - "Cleanup Complete"
          - "=========================================="
          - "Removed:"
          - "  ✓ Node: {{ vm_name }}"
          - "  ✓ Category: {{ category_name }}"
          - "  ✓ HTTP mirror"
          - "  ✓ Kickstart file"
          - "  ✓ PXE boot files"
          - "  ✓ Category PXE config"
          - ""
          - "Note: RHEL ISO at /root/rhel-9.6-x86_64-dvd.iso was NOT deleted"
          - "Note: Installed VM (if any) was NOT deleted"
          - "=========================================="
